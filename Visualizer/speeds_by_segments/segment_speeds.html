<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Route Visualization</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        #map {
            width: 100%;
            height: 90vh;
        }
    </style>
</head>
<body>
    <h1>Bus Route Visualization</h1>
    <div id="map"></div>

    <script>
        // Initialize the map
        const map = L.map('map').setView([59.44386, 24.74724], 14);

        // Add a tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Function to get color based on speed
        function getColor(speed) {
            return speed > 50 ? '#00FF00' : // Fast: Green
               speed > 30 ? '#FFFF00' : // Medium: Yellow
               speed > 10 ? '#FFA500' : // Slow: Orange
                    '#FF0000';  // Very slow: Red
        }

        // Load the CSV data
        Papa.parse('segment_data_202501191625.csv', {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                const data = results.data; // Parsed data

                // Create GeoJSON features from the data
                const features = data.slice(0, Math.ceil(data.length / 10)).map(row => ({
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: row.segment
                            .replace('LINESTRING (', '')
                            .replace(')', '')
                            .split(', ')
                            .map(coord => coord.split(' ').map(Number))
                    },
                    properties: {
                        line: row.line,
                        vehicle_id: row.vehicle_id,
                        speed_kmh: parseFloat(row.speed_kmh)
                    }
                }));

                console.log("Starting to draw the lines");
                // Create a GeoJSON layer
                L.geoJSON({
                    type: 'FeatureCollection',
                    features: features
                }, {
                    style: function(feature) {
                        return {
                            color: getColor(feature.properties.speed_kmh),
                            weight: 3
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        layer.bindPopup(
                            `Line: ${feature.properties.line}<br>` +
                            `Vehicle ID: ${feature.properties.vehicle_id}<br>` +
                            `Speed: ${feature.properties.speed_kmh.toFixed(2)} km/h`
                        );
                    }
                }).addTo(map);
                console.log("Finished drawing the lines");
            }
        });
    </script>
</body>
</html>
