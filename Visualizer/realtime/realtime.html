<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Tallinn Live Transport</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      #map {
        height: 100vh;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      const map = L.map("map").setView([59.437, 24.7535], 13); // Centered on Tallinn

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
      }).addTo(map);

      const markers = {};
      const textMarkers = {};

      function fetchData() {
        console.log("Fetching data...");
        console.log("Current time:", new Date().toLocaleTimeString());
        fetch(`/proxy/gps`)
          .then((res) => res.json())
          .then((data) => {
            const seen = new Set();

            data.features.forEach((feature) => {
              const {
                id: vehicleId,
                type,
                line: lineNum,
                direction,
                destination,
              } = feature.properties;

              const [lon, lat] = feature.geometry.coordinates;

              const key = `${type}-${vehicleId}`;
              seen.add(key);

              const latNum = lat;
              const lonNum = lon;

              const label = `${
                type == "3" ? "Tram" : "Bus"
              } ${lineNum} â†’ ${destination}`;

              const iconType =
                type == "3" ? "Tram" : type == "10" ? "Train" : "Bus";
              const vehicleIcon = L.divIcon({
                html: `<img src="../assets/${iconType}Icon.svg" style="width: 24px; height: 24px; transform: rotate(${direction}deg); transition: transform 1s ease;" />`,
                className: "",
                iconSize: [24, 24],
                iconAnchor: [12, 12],
              });

              if (markers[key]) {
                // Animate to new position
                const currentLatLng = markers[key].getLatLng();
                const newLatLng = L.latLng(latNum, lonNum);

                // Smooth movement animation
                let startTime = null;
                const duration = 15000; // 1 second

                function animateMarker(timestamp) {
                  if (!startTime) startTime = timestamp;
                  const progress = Math.min(
                    (timestamp - startTime) / duration,
                    1
                  );

                  const lat =
                    currentLatLng.lat +
                    (newLatLng.lat - currentLatLng.lat) * progress;
                  const lng =
                    currentLatLng.lng +
                    (newLatLng.lng - currentLatLng.lng) * progress;

                  markers[key].setLatLng([lat, lng]);
                  textMarkers[key].setLatLng([lat, lng]);

                  if (progress < 1) {
                    requestAnimationFrame(animateMarker);
                  } else {
                    markers[key].setIcon(vehicleIcon);
                  }
                }

                requestAnimationFrame(animateMarker);
              } else {
                markers[key] = L.marker([latNum, lonNum], {
                  icon: vehicleIcon,
                  riseOnHover: true,
                  riseOffset: 100,
                })
                  .addTo(map)
                  .bindPopup(label);

                // Add line number text
                const divIcon = L.divIcon({
                  html: `<div style="color: white; font-weight: bold; font-size: 10px; text-align: center; line-height: 24px; transition: all 1s ease;">${lineNum}</div>`,
                  className: "",
                  iconSize: [24, 24],
                  iconAnchor: [12, 12],
                });

                textMarkers[key] = L.marker([latNum, lonNum], {
                  icon: divIcon,
                })
                  .addTo(map)
                  .bindPopup(label);
              }
            });

            // Remove markers that weren't updated this cycle
            for (const key in markers) {
              if (!seen.has(key)) {
                map.removeLayer(markers[key]);
                map.removeLayer(textMarkers[key]);
                delete markers[key];
                delete textMarkers[key];
              }
            }
          })
          .catch((error) => {
            console.error("Error fetching data:", error);
          });
      }

      fetchData();
      setInterval(fetchData, 15000); // refresh every 15s
    </script>
  </body>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #leaflet-marker-icon {
      z-index: 10;
    }
  </style>
</html>
