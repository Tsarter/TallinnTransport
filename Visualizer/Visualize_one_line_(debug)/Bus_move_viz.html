<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Movement Visualization</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Include Chart.js -->
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
        #slider {
            width: 100%;
            margin-top: 10px;
        }
        #speedChartContainer {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Vehicle Speed Visualization</h1>
       
    <div id="map"></div>
    <input type="range" id="slider" min="0" max="0" value="0" step="1">
    <p>Counter: <span id="sliderValue">0</span></p>
    <select id="fileSelect">
        <option value="">Vali s√µiduk</option>
        <!-- <option value="bus_1_2455">bus_1_2455</option>
        <option value="bus_24_1158">bus_24_1158 </option>
        <option value="bus_24_1227">bus_24_1227</option>
        <option value="bus_4_2411">bus_4_2411</option>
        <option value="bus_5_2127">bus_5_2127 </option>
        <option value="bus_23_1038">bus_23_1038</option>
        <option value="bus_4_2411">bus_4_2411</option>
        <option value="bus_5_2127">bus_5_2127 </option>
        <option value="bus_23_1038">bus_23_1038</option> -->

        <option value="bus_10_2417">bus_10_2417</option> <option value="bus_10_2441">bus_10_2441</option> <option value="bus_10_2616">bus_10_2616</option> <option value="bus_10_2707">bus_10_2707</option> <option value="bus_10_2784">bus_10_2784</option> <option value="bus_11_1120">bus_11_1120</option> <option value="bus_11_1961">bus_11_1961</option> <option value="bus_12_1301">bus_12_1301</option> <option value="bus_12_2459">bus_12_2459</option> <option value="bus_12_3270">bus_12_3270</option> <option value="bus_12_3495">bus_12_3495</option> <option value="bus_12_3581">bus_12_3581</option> <option value="bus_12_3582">bus_12_3582</option> <option value="bus_13_1018">bus_13_1018</option> <option value="bus_13_1422">bus_13_1422</option> <option value="bus_13_1442">bus_13_1442</option> <option value="bus_13_2069">bus_13_2069</option> <option value="bus_13_2237">bus_13_2237</option> <option value="bus_13_2255">bus_13_2255</option> <option value="bus_13_2542">bus_13_2542</option> <option value="bus_13_3036">bus_13_3036</option> <option value="bus_13_3070">bus_13_3070</option> <option value="bus_13_3321">bus_13_3321</option> <option value="bus_13_3490">bus_13_3490</option> <option value="bus_14_1115">bus_14_1115</option> <option value="bus_14_2498">bus_14_2498</option> <option value="bus_14_2721">bus_14_2721</option> <option value="bus_14_3530">bus_14_3530</option> <option value="bus_15_3011">bus_15_3011</option> <option value="bus_15_3035">bus_15_3035</option> <option value="bus_15_3382">bus_15_3382</option> <option value="bus_16_2148">bus_16_2148</option> <option value="bus_16_2416">bus_16_2416</option> <option value="bus_16_2501">bus_16_2501</option> <option value="bus_16_2757">bus_16_2757</option> <option value="bus_16_3509">bus_16_3509</option> <option value="bus_18_1249">bus_18_1249</option> <option value="bus_18_1425">bus_18_1425</option> <option value="bus_18_1486">bus_18_1486</option> <option value="bus_18_1631">bus_18_1631</option> <option value="bus_1_2455">bus_1_2455</option> <option value="bus_1_2460">bus_1_2460</option> <option value="bus_1_2483">bus_1_2483</option> <option value="bus_1_2543">bus_1_2543</option> <option value="bus_1_2915">bus_1_2915</option> <option value="bus_20_2132">bus_20_2132</option> <option value="bus_20_2140">bus_20_2140</option> <option value="bus_20_2677">bus_20_2677</option> <option value="bus_20_2700">bus_20_2700</option> <option value="bus_21_1143">bus_21_1143</option> <option value="bus_22_2188">bus_22_2188</option> <option value="bus_22_2726">bus_22_2726</option> <option value="bus_22_3529">bus_22_3529</option> <option value="bus_23_1009">bus_23_1009</option> <option value="bus_23_1013">bus_23_1013</option> <option value="bus_23_1014">bus_23_1014</option> <option value="bus_23_1038">bus_23_1038</option> <option value="bus_23_1347">bus_23_1347</option> <option value="bus_23_1439">bus_23_1439</option> <option value="bus_23_1520">bus_23_1520</option> <option value="bus_23_3583">bus_23_3583</option> <option value="bus_24_1108">bus_24_1108</option> <option value="bus_24_1152">bus_24_1152</option> <option value="bus_24_1158">bus_24_1158</option> <option value="bus_24_1167">bus_24_1167</option> <option value="bus_24_1187">bus_24_1187</option> <option value="bus_24_1227">bus_24_1227</option> <option value="bus_24_1233">bus_24_1233</option> <option value="bus_24_1406">bus_24_1406</option> <option value="bus_24_1473">bus_24_1473</option> <option value="bus_24_1710">bus_24_1710</option> <option value="bus_24_1744">bus_24_1744</option> <option value="bus_24_1908">bus_24_1908</option> <option value="bus_24_3381">bus_24_3381</option> <option value="bus_27_2650">bus_27_2650</option> <option value="bus_27_2660">bus_27_2660</option> <option value="bus_27_2671">bus_27_2671</option> <option value="bus_27_2689">bus_27_2689</option> <option value="bus_27_2775">bus_27_2775</option> <option value="bus_28_1163">bus_28_1163</option> <option value="bus_28_1240">bus_28_1240</option> <option value="bus_28_1243">bus_28_1243</option> <option value="bus_28_1740">bus_28_1740</option> <option value="bus_28_1757">bus_28_1757</option> <option value="bus_29_3306">bus_29_3306</option> <option value="bus_29_3388">bus_29_3388</option> <option value="bus_29_3780">bus_29_3780</option> <option value="bus_2_2189">bus_2_2189</option> <option value="bus_2_2194">bus_2_2194</option> <option value="bus_2_2195">bus_2_2195</option> <option value="bus_2_2325">bus_2_2325</option> <option value="bus_2_2668">bus_2_2668</option> <option value="bus_2_2752">bus_2_2752</option> <option value="bus_31_3029">bus_31_3029</option> <option value="bus_31_3101">bus_31_3101</option> <option value="bus_31_3102">bus_31_3102</option> <option value="bus_31_3211">bus_31_3211</option> <option value="bus_31_3229">bus_31_3229</option> <option value="bus_31_3322">bus_31_3322</option> <option value="bus_31_3511">bus_31_3511</option> <option value="bus_32_2061">bus_32_2061</option> <option value="bus_32_2292">bus_32_2292</option> <option value="bus_32_2724">bus_32_2724</option> <option value="bus_33_2122">bus_33_2122</option> <option value="bus_33_2286">bus_33_2286</option> <option value="bus_33_2526">bus_33_2526</option> <option value="bus_33_2557">bus_33_2557</option> <option value="bus_33_2673">bus_33_2673</option> <option value="bus_33_2720">bus_33_2720</option> <option value="bus_33_2787">bus_33_2787</option> <option value="bus_34_2635">bus_34_2635</option> <option value="bus_34_2716">bus_34_2716</option> <option value="bus_34_3012">bus_34_3012</option> <option value="bus_34_3013">bus_34_3013</option> <option value="bus_35_2515">bus_35_2515</option> <option value="bus_35_3024">bus_35_3024</option> <option value="bus_35_3361">bus_35_3361</option> <option value="bus_35_3466">bus_35_3466</option> <option value="bus_35_3467">bus_35_3467</option> <option value="bus_35_3488">bus_35_3488</option> <option value="bus_35_3536">bus_35_3536</option> <option value="bus_35_3548">bus_35_3548</option> <option value="bus_35_3762">bus_35_3762</option> <option value="bus_35_3792">bus_35_3792</option> <option value="bus_36_1012">bus_36_1012</option> <option value="bus_36_1028">bus_36_1028</option> <option value="bus_36_1305">bus_36_1305</option> <option value="bus_36_1415">bus_36_1415</option> <option value="bus_36_1427">bus_36_1427</option> <option value="bus_36_1518">bus_36_1518</option> <option value="bus_36_1569">bus_36_1569</option> <option value="bus_36_3395">bus_36_3395</option> <option value="bus_37_1238">bus_37_1238</option> <option value="bus_37_1297">bus_37_1297</option> <option value="bus_37_1759">bus_37_1759</option> <option value="bus_38_3313">bus_38_3313</option> <option value="bus_39_3103">bus_39_3103</option> <option value="bus_39_3779">bus_39_3779</option> <option value="bus_3_1112">bus_3_1112</option> <option value="bus_3_1203">bus_3_1203</option> <option value="bus_3_1500">bus_3_1500</option> <option value="bus_3_1568">bus_3_1568</option> <option value="bus_3_1798">bus_3_1798</option> <option value="bus_3_1813">bus_3_1813</option> <option value="bus_3_3431">bus_3_3431</option> <option value="bus_3_3528">bus_3_3528</option> <option value="bus_3_3575">bus_3_3575</option> <option value="bus_40_1021">bus_40_1021</option> <option value="bus_40_1022">bus_40_1022</option> <option value="bus_40_1304">bus_40_1304</option> <option value="bus_40_1384">bus_40_1384</option> <option value="bus_40_1412">bus_40_1412</option> <option value="bus_40_1428">bus_40_1428</option> <option value="bus_40_3551">bus_40_3551</option> <option value="bus_41_1118">bus_41_1118</option> <option value="bus_41_1560">bus_41_1560</option> <option value="bus_42_1214">bus_42_1214</option> <option value="bus_42_1423">bus_42_1423</option> <option value="bus_42_1449">bus_42_1449</option> <option value="bus_42_1563">bus_42_1563</option> <option value="bus_42_2895">bus_42_2895</option> <option value="bus_42_3044">bus_42_3044</option> <option value="bus_42_3365">bus_42_3365</option> <option value="bus_42_3368">bus_42_3368</option> <option value="bus_42_3479">bus_42_3479</option> <option value="bus_42_3550">bus_42_3550</option> <option value="bus_42_3702">bus_42_3702</option> <option value="bus_42_3703">bus_42_3703</option> <option value="bus_44_3030">bus_44_3030</option> <option value="bus_44_3031">bus_44_3031</option> <option value="bus_44_3105">bus_44_3105</option> <option value="bus_44_3217">bus_44_3217</option> <option value="bus_44_3251">bus_44_3251</option> <option value="bus_45_1107">bus_45_1107</option> <option value="bus_45_1116">bus_45_1116</option> <option value="bus_45_1354">bus_45_1354</option> <option value="bus_45_1475">bus_45_1475</option> <option value="bus_45_1861">bus_45_1861</option> <option value="bus_45_3574">bus_45_3574</option> <option value="bus_46_2293">bus_46_2293</option> <option value="bus_46_2294">bus_46_2294</option> <option value="bus_46_2727">bus_46_2727</option> <option value="bus_46_3267">bus_46_3267</option> <option value="bus_49_3261">bus_49_3261</option> <option value="bus_49_3320">bus_49_3320</option> <option value="bus_49_3420">bus_49_3420</option> <option value="bus_49_3450">bus_49_3450</option> <option value="bus_49_3545">bus_49_3545</option> <option value="bus_49_3565">bus_49_3565</option> <option value="bus_4_2411">bus_4_2411</option> <option value="bus_50_3136">bus_50_3136</option> <option value="bus_50_3231">bus_50_3231</option> <option value="bus_50_3457">bus_50_3457</option> <option value="bus_50_3458">bus_50_3458</option> <option value="bus_51_3260">bus_51_3260</option> <option value="bus_51_3469">bus_51_3469</option> <option value="bus_51_3794">bus_51_3794</option> <option value="bus_51_3898">bus_51_3898</option> <option value="bus_54_3379">bus_54_3379</option> <option value="bus_54_3394">bus_54_3394</option> <option value="bus_54_3715">bus_54_3715</option> <option value="bus_54_3810">bus_54_3810</option> <option value="bus_55_3275">bus_55_3275</option> <option value="bus_55_3374">bus_55_3374</option> <option value="bus_55_3380">bus_55_3380</option> <option value="bus_57_2767">bus_57_2767</option> <option value="bus_57_2776">bus_57_2776</option> <option value="bus_58_3032">bus_58_3032</option> <option value="bus_58_3106">bus_58_3106</option> <option value="bus_58_3219">bus_58_3219</option> <option value="bus_58_3278">bus_58_3278</option> <option value="bus_58_3594">bus_58_3594</option> <option value="bus_59_1222">bus_59_1222</option> <option value="bus_59_1408">bus_59_1408</option> <option value="bus_5_2074">bus_5_2074</option> <option value="bus_5_2127">bus_5_2127</option> <option value="bus_5_2284">bus_5_2284</option> <option value="bus_5_2445">bus_5_2445</option> <option value="bus_5_2523">bus_5_2523</option> <option value="bus_5_2524">bus_5_2524</option> <option value="bus_5_2527">bus_5_2527</option> <option value="bus_5_2580">bus_5_2580</option> <option value="bus_5_2645">bus_5_2645</option> <option value="bus_5_2861">bus_5_2861</option> <option value="bus_5_3507">bus_5_3507</option> <option value="bus_60_3021">bus_60_3021</option> <option value="bus_60_3182">bus_60_3182</option> <option value="bus_60_3929">bus_60_3929</option> <option value="bus_61_2324">bus_61_2324</option> <option value="bus_61_2504">bus_61_2504</option> <option value="bus_61_2647">bus_61_2647</option> <option value="bus_61_2777">bus_61_2777</option> <option value="bus_61_2849">bus_61_2849</option> <option value="bus_63_3245">bus_63_3245</option> <option value="bus_63_3308">bus_63_3308</option> <option value="bus_63_3781">bus_63_3781</option> <option value="bus_64_2209">bus_64_2209</option> <option value="bus_64_3535">bus_64_3535</option> <option value="bus_65_3060">bus_65_3060</option> <option value="bus_65_3072">bus_65_3072</option> <option value="bus_65_3135">bus_65_3135</option> <option value="bus_65_3303">bus_65_3303</option> <option value="bus_65_3378">bus_65_3378</option> <option value="bus_66_3154">bus_66_3154</option> <option value="bus_66_3213">bus_66_3213</option> <option value="bus_66_3218">bus_66_3218</option> <option value="bus_66_3220">bus_66_3220</option> <option value="bus_66_3534">bus_66_3534</option> <option value="bus_66_3541">bus_66_3541</option> <option value="bus_66_3547">bus_66_3547</option> <option value="bus_67_1003">bus_67_1003</option> <option value="bus_67_1017">bus_67_1017</option> <option value="bus_67_1029">bus_67_1029</option> <option value="bus_67_1419">bus_67_1419</option> <option value="bus_67_1489">bus_67_1489</option> <option value="bus_67_1493">bus_67_1493</option> <option value="bus_67_3020">bus_67_3020</option> <option value="bus_67_3063">bus_67_3063</option> <option value="bus_67_3129">bus_67_3129</option> <option value="bus_67_3360">bus_67_3360</option> <option value="bus_67_3485">bus_67_3485</option> <option value="bus_67_3584">bus_67_3584</option> <option value="bus_67_3999">bus_67_3999</option> <option value="bus_6_3512">bus_6_3512</option> <option value="bus_6_3532">bus_6_3532</option> <option value="bus_72_2035">bus_72_2035</option> <option value="bus_72_2073">bus_72_2073</option> <option value="bus_72_2221">bus_72_2221</option> <option value="bus_72_2331">bus_72_2331</option> <option value="bus_72_2669">bus_72_2669</option> <option value="bus_72_2723">bus_72_2723</option> <option value="bus_72_2728">bus_72_2728</option> <option value="bus_72_2731">bus_72_2731</option> <option value="bus_73_2032">bus_73_2032</option> <option value="bus_73_2133">bus_73_2133</option> <option value="bus_73_2258">bus_73_2258</option> <option value="bus_73_2683">bus_73_2683</option> <option value="bus_73_2770">bus_73_2770</option> <option value="bus_7_3008">bus_7_3008</option> <option value="bus_7_3274">bus_7_3274</option> <option value="bus_7_3310">bus_7_3310</option> <option value="bus_7_3521">bus_7_3521</option> <option value="bus_7_3552">bus_7_3552</option> <option value="bus_7_3788">bus_7_3788</option> <option value="bus_8_1119">bus_8_1119</option> <option value="bus_8_1169">bus_8_1169</option> <option value="bus_8_1186">bus_8_1186</option> <option value="bus_8_1289">bus_8_1289</option> <option value="bus_8_1353">bus_8_1353</option> <option value="bus_8_1474">bus_8_1474</option> <option value="bus_8_1559">bus_8_1559</option> <option value="bus_8_1829">bus_8_1829</option> <option value="bus_8_3389">bus_8_3389</option> <option value="bus_8_3393">bus_8_3393</option> <option value="bus_8_3573">bus_8_3573</option> <option value="bus_9_1477">bus_9_1477</option> <option value="tram_1_167">tram_1_167</option> <option value="tram_1_170">tram_1_170</option> <option value="tram_1_173">tram_1_173</option> <option value="tram_1_179">tram_1_179</option> <option value="tram_1_503">tram_1_503</option> <option value="tram_1_525">tram_1_525</option> <option value="tram_1_98">tram_1_98</option> <option value="tram_2_102">tram_2_102</option> <option value="tram_2_109">tram_2_109</option> <option value="tram_2_131">tram_2_131</option> <option value="tram_2_505">tram_2_505</option> <option value="tram_2_507">tram_2_507</option> <option value="tram_2_510">tram_2_510</option> <option value="tram_2_512">tram_2_512</option> <option value="tram_2_513">tram_2_513</option> <option value="tram_2_96">tram_2_96</option> <option value="tram_2_97">tram_2_97</option> <option value="tram_3_138">tram_3_138</option> <option value="tram_3_142">tram_3_142</option> <option value="tram_3_516">tram_3_516</option> <option value="tram_4_509">tram_4_509</option> <option value="tram_4_511">tram_4_511</option> <option value="tram_4_514">tram_4_514</option> <option value="tram_4_515">tram_4_515</option> <option value="tram_4_517">tram_4_517</option> <option value="tram_4_518">tram_4_518</option> <option value="tram_4_519">tram_4_519</option> <option value="tram_4_520">tram_4_520</option> <option value="tram_4_523">tram_4_523</option> <option value="tram_5_148">tram_5_148</option> <option value="tram_5_175">tram_5_175</option> <option value="tram_5_177">tram_5_177</option> <option value="tram_5_178">tram_5_178</option> <option value="trol_1_345">trol_1_345</option> <option value="trol_1_440">trol_1_440</option> <option value="trol_1_442">trol_1_442</option> <option value="trol_1_445">trol_1_445</option> <option value="trol_3_437">trol_3_437</option> <option value="trol_3_438">trol_3_438</option> <option value="trol_3_439">trol_3_439</option> <option value="trol_3_441">trol_3_441</option> <option value="trol_4_336">trol_4_336</option> <option value="trol_4_340">trol_4_340</option> <option value="trol_4_342">trol_4_342</option> <option value="trol_4_346">trol_4_346</option> <option value="trol_5_334">trol_5_334</option> <option value="trol_5_335">trol_5_335</option> <option value="trol_5_338">trol_5_338</option> <option value="trol_5_341">trol_5_341</option> <option value="trol_5_343">trol_5_343</option> 


        <!-- Add more options as needed -->
    </select>
    <div id="speedChartContainer">
        <canvas id="speedChart"></canvas> <!-- Canvas for the speed chart -->
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize the map with a default view (it will be updated when coordinates are loaded)
        const map = L.map('map').setView([59.42856, 24.77627], 13);
        L.control.scale({
        position: 'bottomright',  // Position of the scale
        metric: true,             // Display in meters/kilometers
        imperial: false           // Disable miles/feet display
        }).addTo(map);

        // Add the OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Get references to the slider and the display for the current value
        const slider = document.getElementById('slider');
        const sliderValue = document.getElementById('sliderValue');

        // Fileselect
        const fileSelect = document.getElementById('fileSelect');
        fileSelect.addEventListener('change', async (event) => {
            const selectedFile = event.target.value;
    
            if (selectedFile) {
                // Reload the page with the selected file as a query parameter
                window.location.href = `${window.location.pathname}?vehicle_id=${encodeURIComponent(selectedFile)}`;
            }
        });

        // Initialize Chart.js for speed visualization
        const ctx = document.getElementById('speedChart').getContext('2d');
        const speedChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],  // Time points (in seconds)
                datasets: [{
                    label: 'Bus Speed (km/h)',
                    data: [],  // Speed data (will be updated after data is loaded)
                    borderColor: 'rgba(75, 192, 192, 1)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    pointBackgroundColor: [],
                    pointRadius: [],
                    fill: true
                },
                {
                label: 'Average Speed (km/h)',
                data: [],  // Array with avgSpeed for each point
                borderColor: 'rgba(255, 99, 132, 1)',  // Red color for average speed line
                borderDash: [5, 5],  // Dashed line style
                pointRadius: 0,      // No points for average line
                fill: false
            }]
            },
            options: {
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time (s)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Speed (km/h)'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
        function loadRoute(vehicle_id){
                        const [vehicleType, lineNumber] = vehicle_id.split("_");
                        const routeFileName = `${vehicleType}_${lineNumber}_routes.txt`;

                        fetch(`2024-10-04/${routeFileName}`)
                        .then((response) => response.text())
                        .then((routeData) => {
                            const route = routeData.split("\n")[1]; // Simplified: using second line
                            const routePoints = decodePolyline(route);

                            // Draw the route on the map
                            const polyline = L.polyline(routePoints, {
                            color: "blue",
                            weight: 5,
                            opacity: 0.7,
                            }).addTo(map);
                            // Add markers at each route point
                           /*  routePoints.forEach((point) => {
                            L.circleMarker(point, {
                                radius: 4,
                                color: "red",
                                fillColor: "red",
                                fillOpacity: 0.8,
                            }).addTo(map);
                            }); */

                        })
                        // Function to decode the encoded polyline
                        function decodePolyline(encoded) {
                        let points = [];
                        let index = 0,
                            len = encoded.length;
                        let lat = 0,
                            lng = 0;

                        while (index < len) {
                            let b,
                            shift = 0,
                            result = 0;
                            do {
                            b = encoded.charCodeAt(index++) - 63;
                            result |= (b & 0x1f) << shift;
                            shift += 5;
                            } while (b >= 0x20);
                            let dlat = result & 1 ? ~(result >> 1) : result >> 1;
                            lat += dlat;

                            shift = 0;
                            result = 0;
                            do {
                            b = encoded.charCodeAt(index++) - 63;
                            result |= (b & 0x1f) << shift;
                            shift += 5;
                            } while (b >= 0x20);
                            let dlng = result & 1 ? ~(result >> 1) : result >> 1;
                            lng += dlng;

                            points.push([lat * 1e-5, lng * 1e-5]);
                        }

                        return points;
                        }
                    }


        // Function to load coordinates and distances from a JSON file
        async function loadCoordinates(vehicle_id) {
            try {
                const response = await fetch(`movements/bus_movement_${vehicle_id}.json`); // Load the JSON file
                const data = await response.json(); // Parse the JSON data
                const coordinates = data.coordinates;
                const distances = data.distances;
                const times = data.times
                
                let index = 0;

                if (coordinates && coordinates.length > 0) {
                    // Update slider max value based on number of coordinates
                    slider.max = coordinates.length - 1;

                    // Create a marker for the bus
                    let busMarker = L.marker([coordinates[index][1],coordinates[index][0]]).addTo(map);

                    // Function to update the bus position based on slider value
                    function updateBusPosition(index) {
                        busMarker.setLatLng([coordinates[index][1], coordinates[index][0]]);
                        busMarker.bindPopup(vehicle_id + " speed: " + Math.round(distances[index] / 30 * 3.6) + " km/h,dist: " +  Math.round(distances[index])+ " m").openPopup();
                    }

                    // Event listener for the slider to update bus position
                    slider.addEventListener('input', function(){
                        const index = parseInt(this.value);
                        updateBusPosition(index);
                        sliderValue.textContent = index + " Clock: "+ times[index]; // Update displayed value
                        highlightChartPoint(index);
                    });

                    // Populate the speed chart based on the distances
                    function populateSpeedChart() {
                        prev_speed1 = 0
                        prev_speed2 = 0
                        prev_speed3 = 0
                        let avgSpeed = 0
                        distances.forEach((distance, i) => {
                            if (i == 0) return
                            const deltaTime = (new Date(times[i]) - new Date(times[i - 1]))/1000
                            const speedKmh = Math.round(distance / deltaTime * 3.6); // Convert m/s to km/h
                            speedChart.data.labels.push(i * deltaTime);  // Assuming 30-second intervals
                            speedChart.data.datasets[0].data.push((speedKmh + prev_speed1 + prev_speed2 + prev_speed3)/4);
                            speedChart.data.datasets[0].pointRadius.push(0);
                            speedChart.data.datasets[0].pointBackgroundColor.push('rgba(75, 192, 192, 1)');

                            prev_speed3 = prev_speed2
                            prev_speed2 = prev_speed1
                            prev_speed1 = speedKmh
                            avgSpeed = avgSpeed + speedKmh
                            
                        });
                        avgSpeed = avgSpeed / distances.length
                        speedChart.data.datasets[1].data = Array(distances.length).fill(avgSpeed)
                        speedChart.update();
                    }
                    let highlightedIndex = null; // To keep track of the currently highlighted point

                    function highlightChartPoint(index) {
                        if (highlightedIndex !== null) {
                            // Reset the previously highlighted point's style
                            speedChart.data.datasets[0].pointBackgroundColor[highlightedIndex] = 'rgba(75, 192, 192, 1)';  // Default color
                            speedChart.data.datasets[0].pointRadius[highlightedIndex] = 0; // Default radius
                        }
                        // Highlight the current point
                        speedChart.data.datasets[0].pointBackgroundColor[index] = 'rgba(255, 99, 132, 1)'; // Highlight color
                        speedChart.data.datasets[0].pointRadius[index] = 6; // Larger radius for highlight

                        // Keep track of the highlighted index
                        highlightedIndex = index;

                        // Update the chart to reflect changes
                        speedChart.update();
                    }
                

                    // Call the function to populate the speed chart
                    populateSpeedChart();

                } else {
                    console.error("No coordinates found in the file.");
                }
            } catch (error) {
                console.error("Error loading coordinates:", error);
            }
        }
        const urlParams = new URLSearchParams(window.location.search);
        const default_vehicle_id = "bus_24_1158"
        const vehicle_id = urlParams.get('vehicle_id') ?? "bus_24_1158"
        fileSelect.options[0].innerHTML = vehicle_id;

        // Call the function to load the coordinates from the file
        loadCoordinates(vehicle_id);
        loadRoute(vehicle_id)
    </script>
</body>
</html>
